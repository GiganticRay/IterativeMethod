## AIM
> Debugging with CUDA is a frustrating task. Relating turorials are lack over this topic. Here is the basic debug proecss using **vscode** remotely.

## Device Info
+ VSCODE in windows
+ centos server

## Prerequisite
1. configure ssh connection in vscode  to connect centos server. It may be checked through [VsCode SSH Connection Document]. Completed with above work you shall find a password inputbox when you re-open vscode.

![password_enter][password_enter.png]


[VsCode SSH Connection Document]: https://code.visualstudio.com/docs/remote/ssh

2. install relating vscode package.
+ **[Nsight Visual Studio Code Edition][Nsight Visual Studio Code Edition]** for CUDA
+ **[C/C++][C/C++]** for C/C++


## Work Flow

1. FIrst we need to understand the running process of vscode after you press the **F5** (debug button). Vs Code has some configure files in the **.vscode**, a folder in your workspace. there are three important configure files.
	+ settings.json: 
	```
		{
			"files.associations": {
				"stdexcept": "cpp",
				"numeric": "cpp",
				"stdio.h": "c",
				"stdlib.h": "c"
			}
		}
	```
	> you could configure your [intelligence associations][VSCODE_Intelligence] in this file. Intelligence means the code-coloring, auto-complete, etc. Take the third line as an example, *"stdexcept": "cpp"*, this tell vscode to offer "cpp-type" intelligence for "stdexcept". <br> Nsight package configure cuda intelligence **implicitly** for us so we do not have to set it manually.

	+ launch.json:
	```
		{
			// 使用 IntelliSense 了解相关属性。 
			// 悬停以查看现有属性的描述。
			// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387
			"version": "0.2.0",
			"configurations": [
				{
					"name": "CUDA C++: Launch",
					"type": "cuda-gdb", 
					"request": "launch",
					"program": "${fileDirname}/${fileBasenameNoExtension}",
					"preLaunchTask": "cuda pre task",
					"postDebugTask": "cuda post task",
					"debuggerPath": "/usr/local/cuda-11.1/bin/cuda-gdb",
				}
			]
		}
	```
	> "**program**" is compiled executable file generated by "preLaunchTask". "**preLaunchTask**" refers to task defiend in "tasks.json" which shall be run before the begining of debug to generate the executable file. "**postDebugTask**" refers to task defined in "tasks.json" which shall be run after the end of debug to clear stuffs generated during the process. "**debuggerPath**" refers to where is your debug excatly.

	+ task.json
	```
		{
		// See https://go.microsoft.com/fwlink/?LinkId=733558
		// for the documentation about the tasks.json format
		"version": "2.0.0",
		"tasks": [
			{
				"label": "cuda pre task",
				"type": "shell",
				"command": "nvcc",
				"args": [
					"-I /public/home/LeiChao/Document/IterativeMethod/TEST"
					"-g",
					"${file}", 
					"/public/home/LeiChao/Document/IterativeMethod/TEST/testc.c",

					"-o",
					"${fileDirname}/${fileBasenameNoExtension}",
					"-lcudart -lcusparse"
				],
				"group": "build",

				// Use the standard MS compiler pattern to detect errors, warnings and infos
				"problemMatcher": "$msCompile"
			}, 

			{
				"label": "cuda post task",
				"type": "shell",
				//command
				"command": "rm",
				//args
				"args": [
					"${fileDirname}/${fileBasenameNoExtension}"
				],

				"group": "build",
				"presentation": {
					"reveal": "silent"
				},
				"problemMatcher": "$msCompile"
			}
		]
	}

	```
	> each tasks are descrined here to specify the compile argument such as "include path", "command".
	
	+ So when you tap the debug button, VSCODE 
		1. check your debug type (CUDA C++).
		2. execute your preLaunchTask to compile your code to executable files
		3. using debug tools (cuda-gdb) to debug executable fiel.
		4. debugging...
		5. execute your postLaunchTask to clean the workspace.
	
	## Setting Process

	+ The whole process is 
		1. click the set button to create launch.json and specify debug type.
		![debug_setting][debug_setting.png]
		2. configure the *.json like the above section.
			> we must to ensure the right compile parameters are given to the **tasks.json**. In this example *testmain.cu* has dependency on *testc.h*, so the original compile order is:
			```
			nvcc -I ./ -g testmain.cu test.c -o testmain
			```
			> -I refers to include path <br> 
			-g refers to compile with debug info <br>
			testmain.cu must be in the left of test.c since the former one has dependency on the latter one. <br>
			**Absolute path** should be use in tasks.json

		3. set breaking point then click the debug button.
		![debugging png][debugging.png]



[password_enter.png]: ./IMAGE/password_enter.png
[Nsight Visual Studio Code Edition]: https://developer.nvidia.com/nsight-visual-studio-code-edition
[debug_setting.png]: ./IMAGE/debug_setting.png
[debugging.png]: ./IMAGE/debugging.png

[C/C++]: https://github.com/microsoft/vscode-cpptools
[VSCODE_Intelligence]: https://code.visualstudio.com/docs/editor/intellisense